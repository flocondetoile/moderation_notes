<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_entity_view_alter().
 */
function moderation_notes_entity_view_alter(&$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  $build['#cache']['contexts'][] = 'user.permissions';

  if (!_moderation_notes_access($entity)) {
    return;
  }

  $build['#attributes']['data-moderation-notes-entity-id'] = $entity->getEntityTypeId() . '/' . $entity->id();
}

/**
 * Access callback to determine if an Entity can be annotated.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The Entity to check.
 *
 * @return bool
 *   TRUE if the current user can access the Entity, FALSE otherwise.
 */
function _moderation_notes_access(EntityInterface $entity) {
  /** @var \Drupal\content_moderation\ModerationInformation $moderation_information */
  $moderation_information = \Drupal::service('content_moderation.moderation_information');

  // Check if this is the latest moderated revision and if the user has access.
  return \Drupal::currentUser()->hasPermission('access moderation notes')
  && $moderation_information->isModeratedEntity($entity)
  && $moderation_information->isLatestRevision($entity)
  && !$entity->isNew();
}

/**
 * Implements hook_entity_bundle_field_info_alter().
 */
function moderation_notes_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  /** @var \Drupal\content_moderation\ModerationInformation $moderation_information */
  $moderation_information = \Drupal::service('content_moderation.moderation_information');

  if ($moderation_information->shouldModerateEntitiesOfBundle($entity_type, $bundle) && !empty($fields['moderation_state'])) {
    $fields['moderation_state']->addConstraint('ModerationNotes', []);
  }
}
